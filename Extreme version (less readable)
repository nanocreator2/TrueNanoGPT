import tiktoken as K,numpy as N,datasets as D
S,B,T,C,V=1337,8,16,128,50257;O,Z,A,Y,q,L=N.ones,N.zeros,N.arange,N.array,N.sqrt,len;Q=dict(keepdims=1)
r=N.random;r.seed(S);Ri=r.randint;e=K.get_encoding("gpt2");w=lambda t,a=-1,b=-2:t.swapaxes(a,b);s=.176776695;P=lambda z,f=.02:r.normal(0,f,z).astype('f');M=N.tril(O((1,1,T,T),'f'));u=lambda g:g.sum((0,1));f=lambda a:(lambda p:p/p.sum(-1,**Q))(N.exp(a-a.max(-1,**Q)));R=lambda t:t.reshape(B,-1,4,32).transpose(0,2,1,3);U=lambda t:t.transpose(0,2,1,3).reshape(B,-1,C);m=lambda x:x.mean(-1,**Q);v=lambda t,n:t.reshape(-1,n)
d=D.load_dataset("Skylion007/openwebtext",streaming=1)['train'];t=[]
for x in d:
 t+=e.encode(x["text"].strip())
 if L(t)>=2e5:break
W=Y(t,'u2');I=iter(d.skip(100000).shuffle(S,None,10000));i=P((V,C));p=P((T,C));a=[i,p,O(C,'f'),Z(C,'f')]
for _ in'1234':a+=[P((C,C*3)),Z(C*3,'f'),P((C,C),.04*s),Z(C,'f'),O(C,'f'),Z(C,'f'),O(C,'f'),Z(C,'f'),P((C,4*C)),Z(4*C,'f'),P((4*C,C),.04*s),Z(C,'f')]
g,n,o=[[Z(c.shape,'f')for c in a]for _ in'gno'];G=lambda x:Y([x[j:j+17]for j in Ri(0,L(x)-17,(B,))])
def F(x,y=None):
 z=[];h=i[x]+p[A(T)]
 def E(c,j):z.append((c,j));return c@a[j]+a[j+1]
 def H(c,j):b=c.var(-1,**Q);k=(c-m(c))/q(b+1e-5);z.append((k,b,j));return k*a[j]+a[j+1]
 for k in 0,1,2,3:
  j=4+k*12;c=E(H(h,j+4),j);l,b,d=R(c[:,:,:C]),R(c[:,:,C:2*C]),R(c[:,:,2*C:]);X=f(l@w(b)*s+(M-1)*1e9);J=h+E(U(X@d),j+2);c=E(H(J,j+6),j+8);t=N.tanh(.79788456*(c+.044715*c**3));h=J+E(.5*c*(1+t),j+10);z.append((l,b,d,X,c,t))
 J=H(h,2);K=J@i.T
 if y is None:return K
 c=f(v(K,V));c[A(B*T),y.ravel()]-=1;d=c/(B*T*2);g[0]+=v(d,V).T@v(J,C);D=d.reshape(B,-1,V)@i
 def E(d):c,j=z.pop();b=a[j];g[j]+=v(c,b.shape[0]).T@v(d,b.shape[1]);g[j+1]+=u(d);return d@b.T
 def H(d):c,b,j=z.pop();k=d*a[j];g[j]+=u(d*c);g[j+1]+=u(d);return(k-m(k)-c*(k*c).mean(-1,**Q))/q(b+1e-5)
 D=H(D)
 while z:
  l,b,c,X,J,t=z.pop();K=E(D)*(.5*(1+t)+.5*J*(1-t**2)*.79788456*(1+.134145*J**2));D+=H(E(K));j=R(E(D));k=j@w(c);K=X*(k-(k*X).sum(-1,**Q))*s;D+=H(E(N.concatenate([U(K@b),U(w(K)@l),U(w(X)@j)],-1)))
 g[1]+=D.sum(0);N.add.at(g[0],x.ravel(),v(D,C))
b=[];l=0
for c in range(1000):
 X=6e-5+2.7e-4*(1+N.cos(N.pi*(c-200)/800))if c>=200 else 3e-6*(c+1);[j.fill(0)for j in g]
 for _ in 0,1:
  if l<1:
   while L(b)<1e5:
    try:b+=e.encode(next(I)["text"].strip())
    except:break
   h=Y(b,'u2');b=[];l=L(h)//C
  j=G(h);l-=1;F(j[:,:-1],j[:,1:])
 J=sum((j**2).sum()for j in g);k=min(1,1/(J**.5+1e-6))
 for j in range(L(a)):K=g[j]*k;n[j]=.9*n[j]+.1*K;o[j]=.999*o[j]+.001*K**2;a[j]-=X*n[j]/(1-.9**(c+1))/(q(o[j]/(1-.999**(c+1)))+1e-8);a[j]*=1-X*.1*(a[j].ndim>1)
 if not c%100:z=[];exec("j=G(W);K=F(j[:,:-1]).reshape(-1,V);z+=[-N.log(f(K)[A(B*T),j[:,1:].ravel()]).mean()]\n"*20);print(f"step {c} | lr {X} | val_loss {sum(z)/20}")
